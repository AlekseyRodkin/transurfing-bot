{
  "name": "TEST: Transurfing Bot v5 - Engaging Onboarding",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "fe67c348-8b66-456c-9fbc-9a9abadccf1b",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        112,
        720
      ],
      "webhookId": "9ea22cf9-8659-4b62-b987-9f811b385748",
      "credentials": {
        "telegramApi": {
          "id": "XlAeiZ4z9NX2UU0N",
          "name": "transerfing"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "is-voice",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $json.message?.voice }}",
              "rightValue": ""
            },
            {
              "id": "not-callback",
              "operator": {
                "type": "object",
                "operation": "notExists",
                "singleValue": true
              },
              "leftValue": "={{ $json.callback_query }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "46c03f5b-0ed9-490b-af28-5dd0062b3208",
      "name": "‚ùì Is Voice?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        336,
        720
      ]
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/getFile?file_id={{ $json.message.voice.file_id }}",
        "options": {}
      },
      "id": "5fce24bf-cce9-40a6-9c27-090a85253dce",
      "name": "üîä Get Voice File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        560,
        656
      ]
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "4357a849-7851-48cc-8014-a7c53322bc5c",
      "name": "üì• Download Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        784,
        656
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item;\nif (item.binary && item.binary.data) {\n  item.binary.data.fileName = item.binary.data.fileName.replace('.oga', '.ogg');\n  item.binary.data.mimeType = 'audio/ogg';\n  item.binary.data.fileExtension = 'ogg';\n}\nreturn item;"
      },
      "id": "cef25047-063a-40f4-89a3-979031d29224",
      "name": "üîÑ Fix Audio Format",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.groq.com/openai/v1/audio/transcriptions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer GROQ_API_KEY_PLACEHOLDER"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "model",
              "value": "whisper-large-v3-turbo"
            }
          ]
        },
        "options": {}
      },
      "id": "1e7fb14f-8983-45c7-9cf3-91aecdafbca7",
      "name": "üé§ Groq Whisper",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1232,
        656
      ]
    },
    {
      "parameters": {
        "jsCode": "const trigger = $('Telegram Trigger').item.json;\nconst transcription = $json.text;\nconst result = {...trigger, message: {...trigger.message, text: transcription, original_voice: true}};\nreturn result;"
      },
      "id": "4cdde47b-007f-4b8b-98f2-df69d1420844",
      "name": "üìù Set Transcription",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        656
      ]
    },
    {
      "parameters": {},
      "id": "37c973f5-9cd4-4dd9-900f-4b6463922cae",
      "name": "üîÄ Merge Voice",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1680,
        720
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $json.message?.chat?.id || $json.callback_query?.message?.chat?.id }}"
            }
          ]
        }
      },
      "id": "d9ae7f4e-8e3c-466b-a9b7-18c4a30ba725",
      "name": "üîç Find User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1904,
        720
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "user-exists",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $json.id }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "d39c4e87-f181-402f-8ea6-f03d91f9477a",
      "name": "‚ùì User Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        2128,
        720
      ]
    },
    {
      "parameters": {
        "tableId": "user_profiles",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_id",
              "fieldValue": "={{ $('üîÄ Merge Voice').item.json.message?.chat?.id || $('üîÄ Merge Voice').item.json.callback_query?.message?.chat?.id }}"
            },
            {
              "fieldId": "first_name",
              "fieldValue": "={{ $('üîÄ Merge Voice').item.json.message?.from?.first_name || $('üîÄ Merge Voice').item.json.callback_query?.from?.first_name }}"
            },
            {
              "fieldId": "telegram_username",
              "fieldValue": "={{ $('üîÄ Merge Voice').item.json.message?.from?.username || $('üîÄ Merge Voice').item.json.callback_query?.from?.username }}"
            }
          ]
        }
      },
      "id": "9caee554-ab66-4de6-8e25-e6d26f9937fc",
      "name": "‚ûï Create User",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2352,
        800
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "tableId": "user_states",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.id }}"
            },
            {
              "fieldId": "onboarding_step",
              "fieldValue": "0"
            }
          ]
        }
      },
      "id": "b000a84a-b379-4b69-9fee-b767bffca9cf",
      "name": "üìä Create State",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2576,
        800
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const user = $('‚ûï Create User').item.json;\nreturn user;"
      },
      "id": "81f26347-58ac-4c00-817d-0fec49fb6c07",
      "name": "üîß Prepare User Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        800
      ]
    },
    {
      "parameters": {},
      "id": "faab5ee4-d7c8-4a54-bd29-b607b5335cc2",
      "name": "üîÄ Merge User",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        3024,
        720
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.id }}"
            }
          ]
        }
      },
      "id": "3e7178d8-e77b-4fd5-aada-318e21dda167",
      "name": "üìã Get State",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        720
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// üîÄ Route Logic v7 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ report callback –∏ awaiting_report\n\nconst mergeVoice = $('üîÄ Merge Voice').item.json;\nconst user = $('üîÄ Merge User').item.json;\nconst state = $json;\n\nconst isCallback = !!mergeVoice.callback_query;\nconst callbackData = mergeVoice.callback_query?.data || '';\nconst text = mergeVoice.message?.text || '';\nconst chatId = mergeVoice.message?.chat?.id || mergeVoice.callback_query?.message?.chat?.id;\n\nconst step = state?.onboarding_step || 0;\nconst awaitingReport = state?.awaiting_report || false;\nconst isStart = text === '/start';\nconst isSlide = text === '/slide';\nconst isTask = /^(\\/task|–∑–∞–¥–∞–Ω–∏–µ|—Ç–µ–∫—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ)/i.test(text);\nconst isProgress = /^(\\/progress|–ø—Ä–æ–≥—Ä–µ—Å—Å)/i.test(text);\n\nlet route = 'deepseek';\nlet userMessage = text;\n\nif (isCallback) {\n  const callbackRoutes = {\n    'onb_explanation': 'show_explanation',\n    'onb_value': 'show_value',\n    'onb_name': 'ask_name',\n    'emoji_minimal': 'save_emoji_minimal',\n    'emoji_moderate': 'save_emoji_moderate',\n    'emoji_many': 'save_emoji_many',\n    'onb_slide_place': 'ask_slide_place',\n    'slide_save': 'save_final_slide',\n    'slide_rewrite': 'rewrite_slide',\n    'show_full_task': 'show_full_task_msg',\n    'ask_question': 'prompt_question',\n    'report': 'ask_for_report'\n  };\n  route = callbackRoutes[callbackData] || 'unknown_callback';\n}\nelse if (awaitingReport && text && text.length > 0) {\n  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –æ—Ç—á—ë—Ç\n  route = 'save_report';\n}\nelse if (!user.onboarded) {\n  if (isStart && step === 0) {\n    route = 'show_hook';\n  } else if (step === 1) {\n    route = 'save_name';\n  } else if (step === 2) {\n    route = 'save_slide_place';\n  } else if (step === 3) {\n    route = 'save_slide_people';\n  } else if (step === 4) {\n    route = 'save_slide_feeling';\n  }\n}\nelse {\n  if (isStart) {\n    route = 'welcome_back';\n  } else if (isSlide) {\n    route = 'show_slide';\n  } else if (isTask) {\n    route = 'show_full_task_msg';\n  } else if (isProgress) {\n    route = 'show_course_progress';\n  }\n}\n\nreturn {\n  route: route,\n  user_id: user.id,\n  telegram_chat_id: chatId,\n  user_message: userMessage,\n  callback_data: callbackData,\n  is_callback: isCallback,\n  user: user,\n  state: state,\n  trigger: mergeVoice,\n  awaiting_report: awaitingReport\n};"
      },
      "id": "59243d36-dbe5-4389-a2b8-e3e14bc1a09c",
      "name": "üîÄ Route Logic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        720
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "r1",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              },
              "leftValue": "={{ $json.route }}",
              "rightValue": "deepseek"
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "3fb0b9b6-e0c2-4058-aeec-ec1c0b5fc3f1",
      "name": "‚ùì Onboarding?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        3696,
        720
      ]
    },
    {
      "parameters": {
        "jsCode": "// üéØ Onboarding Handler v13 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è save_report\n\nconst data = $json;\nconst route = data.route;\nconst userName = data.user?.preferred_name || data.user?.first_name || '';\n\nlet message = '';\nlet nextStep = null;\nlet saveName = null;\nlet saveStyle = null;\nlet saveSlidePlace = null;\nlet saveSlidePeople = null;\nlet saveSlideFeeling = null;\nlet saveFinalSlide = null;\nlet startCourseAction = false;\nlet inlineKeyboard = null;\nlet showFullTask = false;\nlet setAwaitingReport = false;\nlet saveReportData = null;\n\nswitch (route) {\n  case 'show_hook':\n    message = '‚ú® –ê —á—Ç–æ, –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ, —á—Ç–æ —Å —Ç–æ–±–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∞ —Ç–æ, —á—Ç–æ —Ç—ã —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—à—å?\\n\\n–ó–≤—É—á–∏—Ç –∫—Ä–∞—Å–∏–≤–æ, –Ω–æ –æ–±—ã—á–Ω–æ ‚Äî –ø—É—Å—Ç—ã–µ —Å–ª–æ–≤–∞.\\n\\nüîÆ 78 –¥–Ω–µ–π ‚Äî –∏ —Ç—ã –ø—Ä–æ–≤–µ—Ä–∏—à—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.';\n    inlineKeyboard = [[{text: 'üëâ –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —Ä–∞—Å—Å–∫–∞–∂–∏', callback_data: 'onb_explanation'}]];\n    nextStep = 0;\n    break;\n\n  case 'show_explanation':\n    message = 'üîÆ –¢—Ä–∞–Ω—Å–µ—Ä—Ñ–∏–Ω–≥ ‚Äî —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é. –ù–µ –º–∞–≥–∏—è, –Ω–µ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–∏, –Ω–µ \"–¥—É–º–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω–æ\".\\n\\nü™û –°—É—Ç—å: –º–∏—Ä ‚Äî –∫–∞–∫ –∑–µ—Ä–∫–∞–ª–æ. –ü–æ–∫–∞–∑—ã–≤–∞–µ—à—å —Å—Ç—Ä–∞—Ö ‚Äî –ø–æ–ª—É—á–∞–µ—à—å —Å—Ç—Ä–∞—à–Ω–æ–µ. –ü–æ–∫–∞–∑—ã–≤–∞–µ—à—å —Å–ø–æ–∫–æ–π–Ω—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –ø–æ–ª—É—á–∞–µ—à—å –∂–µ–ª–∞–µ–º–æ–µ.\\n\\nüìö –ó–∞ 78 –¥–Ω–µ–π –æ—Å–≤–æ–∏—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –∫–∞–∫ —Å–Ω–∏–∂–∞—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ü–µ–ª—å—é, –∫–∞–∫ –Ω–µ –∫–æ—Ä–º–∏—Ç—å —á—É–∂–∏–µ \"–º–∞—è—Ç–Ω–∏–∫–∏\" —ç–Ω–µ—Ä–≥–∏–µ–π.';\n    inlineKeyboard = [[{text: 'üéØ –ß—Ç–æ —è –ø–æ–ª—É—á—É —á–µ—Ä–µ–∑ 78 –¥–Ω–µ–π?', callback_data: 'onb_value'}]];\n    break;\n\n  case 'show_value':\n    message = 'üéØ –ß–µ—Ä–µ–∑ 78 –¥–Ω–µ–π —É —Ç–µ–±—è –±—É–¥–µ—Ç:\\n\\n‚úÖ –ß—ë—Ç–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∂–µ–ª–∞–µ–º–æ–≥–æ –±—É–¥—É—â–µ–≥–æ\\n‚úÖ –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∑–∞–º–µ—á–∞—Ç—å, –∫–æ–≥–¥–∞ –º–∏—Ä —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –º—ã—Å–ª–∏\\n‚úÖ –ù–∞–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π\\n‚úÖ –°–ø–æ–∫–æ–π–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ–≤–æ–≥–∏\\n\\nüìÖ –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –æ–¥–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞. –ù–µ —Ç–µ–æ—Ä–∏—è, –∞ –¥–µ–π—Å—Ç–≤–∏–µ.';\n    inlineKeyboard = [[{text: 'üöÄ –ù–∞—á–∏–Ω–∞–µ–º', callback_data: 'onb_name'}]];\n    break;\n\n  case 'ask_name':\n    message = 'ü§ù –û—Ç–ª–∏—á–Ω–æ. –Ø –±—É–¥—É —Ç–≤–æ–∏–º –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º –Ω–∞ —ç—Ç–∏ 78 –¥–Ω–µ–π.\\n\\nüí¨ –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?';\n    nextStep = 1;\n    break;\n\n  case 'save_name':\n    saveName = data.user_message.trim();\n    message = `üëã –ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${saveName}!\\n\\nüé® –ö–∞–∫ —Ç–µ–±–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–µ–µ –æ–±—â–∞—Ç—å—Å—è?`;\n    inlineKeyboard = [\n      [{text: 'üìù –ú–∏–Ω–∏–º—É–º —ç–º–æ–¥–∑–∏', callback_data: 'emoji_minimal'}],\n      [{text: 'üòä –£–º–µ—Ä–µ–Ω–Ω–æ', callback_data: 'emoji_moderate'}],\n      [{text: 'üéâ –ú–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏!', callback_data: 'emoji_many'}]\n    ];\n    nextStep = 1;\n    break;\n\n  case 'save_emoji_minimal':\n  case 'save_emoji_moderate':\n  case 'save_emoji_many':\n    saveStyle = route.replace('save_emoji_', '');\n    const nameForSlide = data.user?.preferred_name || data.user?.first_name || '–¥—Ä—É–≥';\n    message = `üé¨ ${nameForSlide}, –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫—É—Ä—Å–∞ ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–≤–æ–µ–≥–æ –∂–µ–ª–∞–µ–º–æ–≥–æ –±—É–¥—É—â–µ–≥–æ.\\n\\nüí≠ –ù–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –º–µ—á—Ç–∞, –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—Ä–∞–∑: —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, –∫–æ–≥–¥–∞ —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞? –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—à—å—Å—è? –ö—Ç–æ —Ä—è–¥–æ–º?\\n\\nüîÑ –≠—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω—É–∂–Ω–æ \"–∫—Ä—É—Ç–∏—Ç—å\" –≤ –≥–æ–ª–æ–≤–µ. –ö–∞–∫ –∫–∏–Ω–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –≥–¥–µ –≤—Å—ë —É–∂–µ —Å–ª—É—á–∏–ª–æ—Å—å.\\n\\nüéØ –ú—ã –Ω–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ \"—Ü–µ–ª–µ–≤–æ–π —Å–ª–∞–π–¥\".`;\n    inlineKeyboard = [[{text: '‚ú® –ü–æ–Ω—è—Ç–Ω–æ, —Å–æ–∑–¥–∞—ë–º —Å–ª–∞–π–¥', callback_data: 'onb_slide_place'}]];\n    break;\n\n  case 'ask_slide_place':\n    message = 'üåü –ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è, —Ç—ã –¥–æ—Å—Ç–∏–≥ —Ç–æ–≥–æ, —á–µ–≥–æ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ.\\n\\nüëÄ –ß—Ç–æ —Ç—ã –í–ò–î–ò–®–¨ –≤–æ–∫—Ä—É–≥?\\nüìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—à—å—Å—è? –ö–∞–∫–æ–µ —ç—Ç–æ –º–µ—Å—Ç–æ?';\n    nextStep = 2;\n    break;\n\n  case 'save_slide_place':\n    saveSlidePlace = data.user_message;\n    message = 'üë• –ö—Ç–æ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –≤ —ç—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–µ?\\nüé¨ –ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?';\n    nextStep = 3;\n    break;\n\n  case 'save_slide_people':\n    saveSlidePeople = data.user_message;\n    message = 'üí´ –ß—Ç–æ —Ç—ã –ß–£–í–°–¢–í–£–ï–®–¨?\\nüíñ –ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏, –æ—â—É—â–µ–Ω–∏—è –≤ —Ç–µ–ª–µ?';\n    nextStep = 4;\n    break;\n\n  case 'save_slide_feeling':\n    saveSlideFeeling = data.user_message;\n    nextStep = 4;\n    break;\n\n  case 'save_final_slide':\n    const finalPlace = data.state?.slide_place || '';\n    const finalPeople = data.state?.slide_people || '';\n    const finalFeeling = data.state?.slide_feeling || '';\n    saveFinalSlide = `${finalPlace}\\n\\n${finalPeople}\\n\\n${finalFeeling}`;\n    startCourseAction = true;\n    \n    message = '‚úÖ –°–ª–∞–π–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\\n\\nüöÄ –ö—É—Ä—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è.\\n\\nüìÖ –î–ï–ù–¨ 1 –ò–ó 78\\n\\nüåÖ –°–µ–≥–æ–¥–Ω—è ‚Äî –ø—Ä–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ.\\n\\n–ö–æ–≥–¥–∞-—Ç–æ —Ç—ã –≤–∏–¥–µ–ª –º–∏—Ä –∫–∞–∫ —á—É–¥–æ. –ü–æ—Ç–æ–º —Ç–µ–±—è \"—É—Å—ã–ø–∏–ª–∏\" ‚Äî –Ω–∞—É—á–∏–ª–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ. –ü–æ—Ä–∞ –≤—Å–ø–æ–º–Ω–∏—Ç—å.\\n\\nüëÅÔ∏è –°–µ–≥–æ–¥–Ω—è –∑–∞–º–µ—á–∞–π –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –∂–∏–∑–Ω—å –∫–∞–∫ —Å–æ–Ω ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –ø—Ä–∏–≤—ã—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã. –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ—á–∞–π.\\n\\nüîë –≠—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é.';\n    inlineKeyboard = [\n      [{text: 'üìñ –ü–æ–ª–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ', callback_data: 'show_full_task'}],\n      [{text: '‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', callback_data: 'ask_question'}]\n    ];\n    break;\n\n  case 'rewrite_slide':\n    message = '‚úèÔ∏è –•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π –∑–∞–Ω–æ–≤–æ.\\n\\nüåü –ü—Ä–µ–¥—Å—Ç–∞–≤—å: –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è, —Ç—ã –¥–æ—Å—Ç–∏–≥ —Ç–æ–≥–æ, —á–µ–≥–æ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ.\\n\\nüëÄ –ß—Ç–æ —Ç—ã –í–ò–î–ò–®–¨ –≤–æ–∫—Ä—É–≥?\\nüìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—à—å—Å—è? –ö–∞–∫–æ–µ —ç—Ç–æ –º–µ—Å—Ç–æ?';\n    nextStep = 2;\n    break;\n\n  case 'prompt_question':\n    message = '‚ùì –û —á—ë–º —Ö–æ—á–µ—à—å —Å–ø—Ä–æ—Å–∏—Ç—å?\\n\\nüí¨ –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ.';\n    break;\n\n  case 'ask_for_report':\n    message = 'üìù –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç–≤–æ—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–µ–≥–æ–¥–Ω—è?\\n\\n–ß—Ç–æ –∑–∞–º–µ—Ç–∏–ª? –ö–∞–∫–∏–µ –º—ã—Å–ª–∏ –∏–ª–∏ –æ—â—É—â–µ–Ω–∏—è –±—ã–ª–∏?';\n    setAwaitingReport = true;\n    break;\n\n  case 'save_report':\n    // –î–∞–Ω–Ω—ã–µ –¥–ª—è RPC ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç üì§ Send Report Confirmation\n    saveReportData = {\n      telegram_id: data.trigger?.message?.chat?.id || data.telegram_chat_id,\n      report_text: data.user_message\n    };\n    break;\n\n  case 'show_full_task_msg':\n    showFullTask = true;\n    break;\n\n  case 'welcome_back':\n    const slide = data.state?.target_slide || '–Ω–µ –∑–∞–¥–∞–Ω';\n    const uName = data.user?.preferred_name || data.user?.first_name || '–¥—Ä—É–≥';\n    message = `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${uName}!\\n\\nüéØ –¢–≤–æ–π —Ü–µ–ª–µ–≤–æ–π —Å–ª–∞–π–¥:\\n\"${slide}\"\\n\\nüí¨ –•–æ—á–µ—à—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ª–∞–π–¥ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏–º?`;\n    break;\n\n  case 'show_slide':\n    const currentSlide = data.state?.target_slide || null;\n    const slideName = data.user?.preferred_name || data.user?.first_name || '–¥—Ä—É–≥';\n    if (currentSlide) {\n      message = `üéØ –¢–≤–æ–π —Ü–µ–ª–µ–≤–æ–π —Å–ª–∞–π–¥, ${slideName}:\\n\\n\"${currentSlide}\"\\n\\n‚úèÔ∏è –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ª–∞–π–¥, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç ‚Äî —è –ø–æ–π–º—É –∏ —Å–æ—Ö—Ä–∞–Ω—é ‚ú®`;\n    } else {\n      message = `${slideName}, —É —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ ü§î\\n\\nüí≠ –ù–∞–ø–∏—à–∏ –º–Ω–µ —Å–≤–æ–π —Å–ª–∞–π–¥ ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫—É –∂–µ–ª–∞–µ–º–æ–≥–æ –±—É–¥—É—â–µ–≥–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.`;\n    }\n    break;\n\n  default:\n    message = 'ü§î –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ù–∞–ø–∏—à–∏ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.';\n}\n\nreturn {\n  chat_id: data.telegram_chat_id,\n  text: message,\n  inline_keyboard: inlineKeyboard,\n  user_id: data.user_id,\n  next_step: nextStep,\n  save_name: saveName,\n  save_style: saveStyle,\n  save_slide_place: saveSlidePlace,\n  save_slide_people: saveSlidePeople,\n  save_slide_feeling: saveSlideFeeling,\n  save_final_slide: saveFinalSlide,\n  start_course_action: startCourseAction,\n  show_full_task: showFullTask,\n  set_awaiting_report: setAwaitingReport,\n  save_report_data: saveReportData,\n  route: route,\n  is_callback: data.is_callback,\n  callback_id: data.trigger?.callback_query?.id\n};"
      },
      "id": "74e10277-4171-41f6-a404-89c9473f89f4",
      "name": "üéØ Onboarding Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "skip-main-chain",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $json.save_final_slide }}",
              "rightValue": ""
            },
            {
              "id": "dbf210b3-0b18-43f1-8a86-f9fa161b196a",
              "leftValue": "={{ $json.show_full_task }}",
              "rightValue": "boolean ‚Üí is true",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "skip-main-chain-001",
      "name": "‚ùì Skip Main Chain?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4144,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-name",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_name }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "254f4e8e-d5ec-4389-a715-5b0cc320cd65",
      "name": "‚ùì Save Name?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4368,
        176
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "preferred_name",
              "fieldValue": "={{ $('üéØ Onboarding Handler').item.json.save_name }}"
            }
          ]
        }
      },
      "id": "4adb7c17-f017-494d-85c5-9a3199b6bfcf",
      "name": "üíæ Save Name",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4592,
        96
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-style",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_style }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "17a51412-0895-4dd5-a8f0-328f4aaa0f76",
      "name": "‚ùì Save Style?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4816,
        176
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "preferences",
              "fieldValue": "={{ JSON.stringify({ emoji_style: $('üéØ Onboarding Handler').item.json.save_style }) }}"
            }
          ]
        }
      },
      "id": "f20c05fb-8bc9-4a3a-9ab4-c90c4da0d8dc",
      "name": "üíæ Save Style",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5040,
        96
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-slide-place",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_slide_place }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "f78bfd94-dc85-4e90-87ef-4571350d9074",
      "name": "‚ùì Save Slide (Onb)?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        5264,
        176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–ü—Ä–µ–æ–±—Ä–∞–∑—É–π –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ —è—Ä–∫–∏–π –æ–±—Ä–∞–∑ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞.\\n\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\\n- –û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è\\n- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞\\n- –ò—Å–ø—Ä–∞–≤—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é\\n- –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∂–∏–≤—ã–º –∏ –æ–±—Ä–∞–∑–Ω—ã–º\\n- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ\\n- –û—Ç–≤–µ—Ç: –¢–û–õ–¨–ö–û —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($('üéØ Onboarding Handler').item.json.save_slide_place) }}\n    }\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "enhance-slide-place-001",
      "name": "‚ú® Enhance Slide Place",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5488,
        16
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "slide_place",
              "fieldValue": "={{ $json.choices[0].message.content }}"
            }
          ]
        }
      },
      "id": "be7b4768-428f-44f1-89aa-8f2a4bbf5399",
      "name": "üíæ Save Slide (Onb)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5712,
        16
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-slide-people",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_slide_people }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "bed010bb-a7e5-4fdd-b092-bda7d990a7d8",
      "name": "‚ùì Save Morning?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        5936,
        176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–ü—Ä–µ–æ–±—Ä–∞–∑—É–π –æ–ø–∏—Å–∞–Ω–∏–µ –ª—é–¥–µ–π –∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ —è—Ä–∫–∏–π –æ–±—Ä–∞–∑ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞.\\n\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\\n- –û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è\\n- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞\\n- –ò—Å–ø—Ä–∞–≤—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é\\n- –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∂–∏–≤—ã–º –∏ –æ–±—Ä–∞–∑–Ω—ã–º\\n- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ\\n- –û—Ç–≤–µ—Ç: –¢–û–õ–¨–ö–û —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($('üéØ Onboarding Handler').item.json.save_slide_people) }}\n    }\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "enhance-slide-people-001",
      "name": "‚ú® Enhance Slide People",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6160,
        16
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "slide_people",
              "fieldValue": "={{ $json.choices[0].message.content }}"
            }
          ]
        }
      },
      "id": "0c3e5c79-26a3-4381-bf0a-520ab8e3b01b",
      "name": "üíæ Save Morning",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        6384,
        16
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-slide-feeling",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_slide_feeling }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "2ace8576-3aab-4c62-9060-e144f97e5228",
      "name": "‚ùì Save Evening?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        6608,
        176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–ü—Ä–µ–æ–±—Ä–∞–∑—É–π –æ–ø–∏—Å–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤ –∏ –æ—â—É—â–µ–Ω–∏–π –≤ —è—Ä–∫–∏–π –æ–±—Ä–∞–∑ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞.\\n\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\\n- –û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è\\n- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞\\n- –ò—Å–ø—Ä–∞–≤—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é\\n- –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∂–∏–≤—ã–º –∏ –æ–±—Ä–∞–∑–Ω—ã–º\\n- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ\\n- –û—Ç–≤–µ—Ç: –¢–û–õ–¨–ö–û —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($('üéØ Onboarding Handler').item.json.save_slide_feeling) }}\n    }\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "enhance-slide-feeling-001",
      "name": "‚ú® Enhance Slide Feeling",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6832,
        16
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "slide_feeling",
              "fieldValue": "={{ $json.choices[0].message.content }}"
            }
          ]
        }
      },
      "id": "5960d483-1640-433d-af27-a72630657d3a",
      "name": "üíæ Save Evening",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7056,
        16
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "onboarded",
              "fieldValue": "true"
            }
          ]
        }
      },
      "id": "6f9f12ab-058b-4198-ba29-8ccdb5ce88a2",
      "name": "‚úÖ Set Onboarded",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4704,
        -176
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-final-slide",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_final_slide }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "afceb085-237e-4b52-a6a1-404b348f97a2",
      "name": "‚ùì Save Feature (Onb)?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4144,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "target_slide",
              "fieldValue": "={{ $('üéØ Onboarding Handler').item.json.save_final_slide }}"
            }
          ]
        }
      },
      "id": "0d4cbbc0-7b28-434b-8439-4575472b4893",
      "name": "üíæ Save Feature (Onb)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4368,
        -96
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-next",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.next_step }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "26f2d4ea-6d9f-4490-8666-94a10e55ff7d",
      "name": "‚ùì Update Step?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        7616,
        176
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "onboarding_step",
              "fieldValue": "={{ $('üéØ Onboarding Handler').item.json.next_step }}"
            }
          ]
        }
      },
      "id": "c834b440-260a-43db-8d3f-af8350566768",
      "name": "üìä Update Step",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7840,
        96
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üéØ Onboarding Handler').item.json.chat_id }},\n  \"text\": {{ JSON.stringify($('üéØ Onboarding Handler').item.json.text) }}{{ $('üéØ Onboarding Handler').item.json.inline_keyboard ? ',\\n  \"reply_markup\": {\"inline_keyboard\": ' + JSON.stringify($('üéØ Onboarding Handler').item.json.inline_keyboard) + '}' : '' }}\n}",
        "options": {}
      },
      "id": "e96a0f94-95f4-4d11-b4bf-8803b8ba6258",
      "name": "üì§ Send Onboarding Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8064,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "is-slide-feeling",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.save_slide_feeling }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "needs-slide-preview-001",
      "name": "‚ùì Needs Slide Preview?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        7168,
        16
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        }
      },
      "id": "load-full-state-001",
      "name": "üìã Load Full State",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7280,
        -64
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"–û–±—ä–µ–¥–∏–Ω–∏ —Ç—Ä–∏ —á–∞—Å—Ç–∏ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ –≤ –æ–¥–∏–Ω —Å–≤—è–∑–Ω—ã–π —Ç–µ–∫—Å—Ç.\\n\\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\\n- –ï–¥–∏–Ω–æ–µ —Å–≤—è–∑–Ω–æ–µ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞\\n- –ù–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å\\n- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï –¥–µ—Ç–∞–ª–∏ –∏–∑ –≤—Å–µ—Ö —Ç—Ä—ë—Ö —á–∞—Å—Ç–µ–π\\n- –ò—Å–ø—Ä–∞–≤—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é\\n- –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∂–∏–≤—ã–º –∏ –æ–±—Ä–∞–∑–Ω—ã–º\\n- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–æ–≥–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ\\n- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∏–ø–∞ \\\"–ú–µ—Å—Ç–æ:\\\", \\\"–õ—é–¥–∏:\\\", \\\"–ß—É–≤—Å—Ç–≤–∞:\\\"\\n- –û—Ç–≤–µ—Ç: —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"–ú–ï–°–¢–û: {{ $json.slide_place }}\\n\\n–õ–Æ–î–ò –ò –î–ï–ô–°–¢–í–ò–Ø: {{ $json.slide_people }}\\n\\n–ß–£–í–°–¢–í–ê: {{ $json.slide_feeling }}\"\n    }\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 800\n}",
        "options": {}
      },
      "id": "enhance-full-slide-001",
      "name": "‚ú® Enhance Full Slide",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7504,
        -64
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üéØ Onboarding Handler').item.json.chat_id }},\n  \"text\": \"üéØ –í–æ—Ç —Ç–≤–æ–π —Ü–µ–ª–µ–≤–æ–π —Å–ª–∞–π–¥:\\n\\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n{{ $json.choices[0].message.content.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n\\nüß≠ –≠—Ç–æ —Ç–≤–æ—è —Ç–æ—á–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è. –ë—É–¥–µ–º –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–µ–π –≤–µ—Å—å –∫—É—Ä—Å.\",\n  \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"‚úÖ –í—Å—ë –≤–µ—Ä–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º\", \"callback_data\": \"slide_save\"}], [{\"text\": \"‚úèÔ∏è –•–æ—á—É –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å\", \"callback_data\": \"slide_rewrite\"}]]}\n}",
        "options": {}
      },
      "id": "send-slide-preview-001",
      "name": "üì§ Send Slide Preview",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7728,
        -64
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conversation_history",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üîÄ Route Logic').item.json.user_id }}"
            }
          ]
        }
      },
      "id": "aa47d63b-fbe7-4901-9332-c930400df5e3",
      "name": "üìú Get History",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3696,
        1504
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": {{ JSON.stringify($json.messages) }},\n  \"temperature\": 0.7,\n  \"max_tokens\": 1000\n}",
        "options": {}
      },
      "id": "0a66487d-286e-45b9-bd59-bd2f9a9b9a94",
      "name": "ü§ñ DeepSeek API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        1488
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $json.choices[0].message.content;\nconst context = $('üîß Build LLM Context2').item.json;\n\nlet slideToSave = null;\nlet featureRequest = null;\nlet changeName = null;\nlet changeStyle = null;\nlet cleanResponse = response;\n\nconst slideMatch = response.match(/\\{\\s*\"action\"\\s*:\\s*\"save_slide\"\\s*,\\s*\"slide\"\\s*:\\s*\"([^\"]+)\"\\s*\\}/i);\nif (slideMatch) { slideToSave = slideMatch[1]; cleanResponse = cleanResponse.replace(slideMatch[0], '').trim(); }\n\nconst featureMatch = response.match(/\\{\\s*\"action\"\\s*:\\s*\"feature_request\"\\s*,\\s*\"request\"\\s*:\\s*\"([^\"]+)\"\\s*\\}/i);\nif (featureMatch) { featureRequest = featureMatch[1]; cleanResponse = cleanResponse.replace(featureMatch[0], '').trim(); }\n\nconst nameMatch = response.match(/\\{\\s*\"action\"\\s*:\\s*\"change_name\"\\s*,\\s*\"name\"\\s*:\\s*\"([^\"]+)\"\\s*\\}/i);\nif (nameMatch) { changeName = nameMatch[1]; cleanResponse = cleanResponse.replace(nameMatch[0], '').trim(); }\n\nconst styleMatch = response.match(/\\{\\s*\"action\"\\s*:\\s*\"change_style\"\\s*,\\s*\"style\"\\s*:\\s*\"([^\"]+)\"\\s*\\}/i);\nif (styleMatch) { changeStyle = styleMatch[1]; cleanResponse = cleanResponse.replace(styleMatch[0], '').trim(); }\n\nreturn {\n  response: cleanResponse,\n  slideToSave: slideToSave,\n  featureRequest: featureRequest,\n  changeName: changeName,\n  changeStyle: changeStyle,\n  user_id: context.user_id,\n  telegram_chat_id: context.telegram_chat_id,\n  user_message: context.user_message\n};"
      },
      "id": "e6e33855-1ce0-4e22-af0d-40bcd73d98d6",
      "name": "üéØ Parse Actions",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4592,
        1488
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-slide-ds",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $json.slideToSave }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "dc549f93-64ec-4127-94a1-9bd5b692fe91",
      "name": "‚ùì Has Slide?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4816,
        1488
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "target_slide",
              "fieldValue": "={{ $json.slideToSave }}"
            }
          ]
        }
      },
      "id": "b46928d1-f471-43b7-bf85-4047988209f9",
      "name": "üíæ Save Slide (DS)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5040,
        768
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-feature",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Parse Actions').item.json.featureRequest }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "35f3ec3a-4adb-4e3b-aa20-c6cd43e4ef8f",
      "name": "‚ùì Has Feature Request?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        5264,
        864
      ]
    },
    {
      "parameters": {
        "tableId": "feature_requests",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.user_id }}"
            },
            {
              "fieldId": "telegram_chat_id",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.telegram_chat_id }}"
            },
            {
              "fieldId": "request_text",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.featureRequest }}"
            },
            {
              "fieldId": "context",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.user_message }}"
            }
          ]
        }
      },
      "id": "5a9b2bc2-ca90-422f-8eae-29707eb6258e",
      "name": "üíæ Save Feature Request",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5488,
        864
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-change-name",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Parse Actions').item.json.changeName }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "84466191-a6c9-419f-ad1c-13a3538080c9",
      "name": "‚ùì Change Name?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        5264,
        1056
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Parse Actions').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "preferred_name",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.changeName }}"
            }
          ]
        }
      },
      "id": "9482d9f8-b282-49f8-9d00-290f3dff8f90",
      "name": "üíæ Save New Name",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5488,
        1056
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-change-style",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('üéØ Parse Actions').item.json.changeStyle }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "9f38bc81-074f-44d3-bb7b-d59c0546a40f",
      "name": "‚ùì Change Style?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        5264,
        1248
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Parse Actions').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "preferences",
              "fieldValue": "={{ JSON.stringify({ emoji_style: $('üéØ Parse Actions').item.json.changeStyle }) }}"
            }
          ]
        }
      },
      "id": "59a32f11-689c-43c2-9da1-3d95002fc967",
      "name": "üíæ Save New Style",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5488,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "tableId": "conversation_history",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "user"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.user_message }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            }
          ]
        }
      },
      "id": "1b4d7a7e-3922-4257-a743-426a19b0165d",
      "name": "üíæ Save User Msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5264,
        1440
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "tableId": "conversation_history",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.user_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "assistant"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('üéØ Parse Actions').item.json.response }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "text"
            }
          ]
        }
      },
      "id": "09f1eb84-e4e7-4f74-b477-25291bf905b3",
      "name": "üíæ Save Bot Msg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5264,
        1824
      ],
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('üéØ Parse Actions').item.json.telegram_chat_id }}",
        "text": "={{ $('üéØ Parse Actions').item.json.response }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "97d7f9b8-733d-4bef-89ae-3daaaff484b6",
      "name": "üì§ Send Reply",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5264,
        1632
      ],
      "webhookId": "b638bf9a-f2ec-4355-a91d-97d90abc67c4",
      "credentials": {
        "telegramApi": {
          "id": "XlAeiZ4z9NX2UU0N",
          "name": "transerfing"
        }
      }
    },
    {
      "parameters": {
        "content": "## üßò Transurfing Bot v11\n\n### NEW:\n‚ú® Report handling (ask_for_report)\n‚ú® awaiting_report state\n\n### Flow:\nHandler ‚Üí ‚ùì Show Full Task?\n  ‚Üí true ‚Üí üìã Get Task ‚Üí üì§ Send\n  ‚Üí false ‚Üí main chain",
        "height": 200,
        "width": 300,
        "color": 7
      },
      "id": "5d59c8a9-dcd9-49eb-9959-c1d772adcde4",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -144,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "start-course",
              "leftValue": "={{ $json.start_course_action }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4144,
        464
      ],
      "id": "78696142-13c9-49cb-9914-8a1f7ec72285",
      "name": "‚ùì Start Course?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/start_course",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"p_user_id\": \"{{ $('üéØ Onboarding Handler').item.json.user_id }}\", \"p_program_slug\": \"78days\" }",
        "options": {}
      },
      "id": "ecd8ae91-130f-44b7-bf18-493465b0b73b",
      "name": "üöÄ Start Course RPC",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        464
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/get_course_task",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"p_user_id\": \"{{ $('üîÄ Route Logic').item.json.user_id }}\", \"p_program_slug\": \"78days\" }",
        "options": {}
      },
      "id": "c07ad2c0-34cf-4b3a-a9b4-74e7ae062663",
      "name": "üìã Get Course Task1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4016,
        1824
      ]
    },
    {
      "parameters": {
        "jsCode": "// üîß Build LLM Context v3.3\n\nconst routeData = $('üîÄ Route Logic').first().json;\nconst userState = $('üìã Get State').first().json;\nconst courseTask = $('üìã Get Course Task1').first()?.json || {};\nconst history = $('üìú Get History').all() || [];\n\nconst preferredName = routeData.user?.preferred_name || routeData.user?.first_name || '–¥—Ä—É–≥';\nconst targetSlide = userState?.target_slide || null;\n\nlet emojiStyle = 'moderate';\nif (routeData.user?.preferences) {\n  const prefs = typeof routeData.user.preferences === 'string' \n    ? JSON.parse(routeData.user.preferences) \n    : routeData.user.preferences;\n  emojiStyle = prefs.emoji_style || 'moderate';\n}\n\nconst currentDay = courseTask?.current_day || 1;\nconst totalDays = courseTask?.total_days || 78;\nconst taskTitle = courseTask?.task_title || '–ù–∞—á–∞–ª–æ –∫—É—Ä—Å–∞';\nconst taskContent = courseTask?.task_content || '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫—É—Ä—Å!';\n\nconst isFirstContact = !history || history.length < 2;\n\nlet emojiInstruction = '';\nif (emojiStyle === 'minimal') {\n  emojiInstruction = '–ò—Å–ø–æ–ª—å–∑—É–π –º–∏–Ω–∏–º—É–º —ç–º–æ–¥–∑–∏.';\n} else if (emojiStyle === 'many') {\n  emojiInstruction = '–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∞–∫—Ç–∏–≤–Ω–æ.';\n} else {\n  emojiInstruction = '–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ.';\n}\n\nconst systemPrompt = `–¢—ã ‚Äî AI-–∫–æ—É—á –∫—É—Ä—Å–∞ \"78 –¥–Ω–µ–π —Å –¢—Ä–∞–Ω—Å–µ—Ä—Ñ–∏–Ω–≥–æ–º\".\n\n# –ö–æ–Ω—Ç–µ–∫—Å—Ç\n- –ò–º—è: ${preferredName}\n- –î–µ–Ω—å –∫—É—Ä—Å–∞: ${currentDay} –∏–∑ ${totalDays}\n- –ó–∞–¥–∞–Ω–∏–µ –¥–Ω—è: ${taskTitle}\n- –°–ª–∞–π–¥: ${targetSlide || '—Å–æ–∑–¥–∞—ë—Ç—Å—è'}\n\n# –ó–ê–î–ê–ù–ò–ï –î–ù–Ø ${currentDay}\n${taskContent}\n\n# –ü–æ–≤–µ–¥–µ–Ω–∏–µ\n1. OFF-TOPIC –∑–∞–ø—Ä–µ—â—ë–Ω\n2. –°–≤–æ–±–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ –¢—Ä–∞–Ω—Å–µ—Ä—Ñ–∏–Ω–≥–∞\n3. –ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Å—É—Ç—å—é –∑–∞–¥–∞–Ω–∏—è\n4. –ü–æ–ª–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É\n5. –ú—è–≥–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ\n\n${emojiInstruction}`;\n\nlet messages = [{ role: 'system', content: systemPrompt }];\n\nif (history && history.length > 0) {\n  const sortedHistory = history.slice(-20).reverse();\n  for (const msg of sortedHistory) {\n    if (msg.json.role && msg.json.content) {\n      messages.push({ role: msg.json.role, content: msg.json.content });\n    }\n  }\n}\n\nmessages.push({ role: 'user', content: routeData.user_message });\n\nreturn {\n  messages: messages,\n  user_id: routeData.user_id,\n  telegram_chat_id: routeData.telegram_chat_id,\n  user_message: routeData.user_message,\n  target_slide: targetSlide,\n  current_day: currentDay,\n  task_title: taskTitle\n};"
      },
      "id": "4c1e3682-c6d7-464e-b5b4-9305b6b60234",
      "name": "üîß Build LLM Context2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4240,
        1840
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "show-full-task",
              "leftValue": "={{ $json.show_full_task }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4144,
        608
      ],
      "id": "show-full-task-if-001",
      "name": "‚ùì Show Full Task?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/get_course_task",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"p_user_id\": \"{{ $('üéØ Onboarding Handler').item.json.user_id }}\", \"p_program_slug\": \"78days\" }",
        "options": {}
      },
      "id": "get-task-for-button-001",
      "name": "üìã Get Task For Button",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        608
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "= {\n    \"chat_id\": {{ $('üéØ Onboarding Handler').item.json.chat_id }},\n    \"text\": {{ JSON.stringify(\"üìñ –î–ï–ù–¨ \" + $json.current_day + \" –ò–ó \" + $json.total_days + \"\\n\\nüéØ \" + $json.task_title + \"\\n\\n\" + $json.task_content) }},\n    \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å\", \"callback_data\": \"ask_question\"}]]}\n  }",
        "options": {}
      },
      "id": "send-full-task-001",
      "name": "üì§ Send Full Task",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4592,
        608
      ]
    },
    {
      "id": "281f9d7d-c386-4f60-aff4-59083e90064d",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4144,
        752
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "set-awaiting-report",
              "leftValue": "={{ $json.set_awaiting_report }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "‚ùì Set Awaiting Report?"
    },
    {
      "id": "8a6a94ef-403b-44b5-80d0-e7e3cec3bd74",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4368,
        752
      ],
      "parameters": {
        "operation": "update",
        "tableId": "user_states",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('üéØ Onboarding Handler').item.json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "awaiting_report",
              "fieldValue": "true"
            }
          ]
        }
      },
      "name": "üíæ Set Awaiting Report",
      "credentials": {
        "supabaseApi": {
          "id": "eVA9cENByBOTkcLf",
          "name": "Supabase account 3"
        }
      }
    },
    {
      "id": "49ad3151-65fb-429e-a5cd-bd8507bdf4a3",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        4144,
        896
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "save-report-check",
              "leftValue": "={{ $json.save_report_data }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "‚ùì Save Report?"
    },
    {
      "id": "dc5c757a-afc4-4678-be21-ef956e5d8f1b",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        896
      ],
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/save_report_and_advance_day",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cHhkZWZraXhocm1zcHFrcXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDIwNjQsImV4cCI6MjA4MzExODA2NH0.DcVYJEWfDVvgMTqvL9Yj5AZ-a1AVgNiCP9q6roBfCmQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"p_telegram_id\": {{ $('üéØ Onboarding Handler').item.json.save_report_data.telegram_id }}, \"p_report_text\": {{ JSON.stringify($('üéØ Onboarding Handler').item.json.save_report_data.report_text) }} }",
        "options": {}
      },
      "name": "üîÑ Save Report RPC"
    },
    {
      "id": "34ecbeb3-1511-44a4-b49f-346c6bd19810",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4592,
        896
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8229894344:AAG01r4rpN2h2mSMxKbjAu6UDypRgcg2rAg/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üîß Build Report Context').item.json.chat_id }},\n  \"text\": {{ JSON.stringify($json.choices[0].message.content) }}\n}",
        "options": {}
      },
      "name": "üì§ Send Report Reply"
    },
    {
      "id": "e1462093-0a98-459b-9a1e-d4c293f84b02",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        7840,
        176
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-text",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              },
              "leftValue": "={{ $('üéØ Onboarding Handler').item.json.text }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "name": "‚ùì Has Text?"
    },
    {
      "id": "bf37036c-4768-4437-8861-feee01165e62",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4592,
        1040
      ],
      "parameters": {
        "jsCode": "// Build context for DeepSeek report response\n\nconst rpcResult = $json; // {new_day, completed, ...}\nconst handler = $('üéØ Onboarding Handler').item.json;\nconst routeData = $('üîÄ Route Logic').item.json;\n\nconst preferredName = routeData.user?.preferred_name || routeData.user?.first_name || '–¥—Ä—É–≥';\nconst reportText = handler.save_report_data.report_text;\nconst newDay = rpcResult.new_day;\nconst completed = rpcResult.completed;\n\nconst systemPrompt = `–¢—ã ‚Äî AI-–∫–æ—É—á –∫—É—Ä—Å–∞ \"78 –¥–Ω–µ–π —Å –¢—Ä–∞–Ω—Å–µ—Ä—Ñ–∏–Ω–≥–æ–º\".\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${preferredName} —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏—Å–ª–∞–ª –æ—Ç—á—ë—Ç –æ –ø—Ä–∞–∫—Ç–∏–∫–µ.\n\n–ó–ê–î–ê–ß–ê:\n1. –¢–µ–ø–ª–æ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –∑–∞ –æ—Ç—á—ë—Ç\n2. –ö—Ä–∞—Ç–∫–æ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Ç–æ, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n3. ${completed ? '–ü–æ–∑–¥—Ä–∞–≤—å —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∫—É—Ä—Å–∞!' : `–£–ø–æ–º—è–Ω–∏, —á—Ç–æ –∑–∞–≤—Ç—Ä–∞ –î–µ–Ω—å ${newDay}`}\n4. –ü–æ–∂–µ–ª–∞–π –¥–æ–±—Ä–æ–π –Ω–æ—á–∏\n\n–°—Ç–∏–ª—å: —Ç—ë–ø–ª—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ.`;\n\nconst messages = [\n  { role: 'system', content: systemPrompt },\n  { role: 'user', content: reportText }\n];\n\nreturn {\n  messages: messages,\n  chat_id: handler.chat_id,\n  new_day: newDay,\n  completed: completed\n};"
      },
      "name": "üîß Build Report Context"
    },
    {
      "id": "86c7c787-028f-407d-826f-f99ff8ae68f4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        1040
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"deepseek-chat\",\n  \"messages\": {{ JSON.stringify($json.messages) }},\n  \"temperature\": 0.7,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "name": "ü§ñ DeepSeek Report",
      "credentials": {
        "httpHeaderAuth": {
          "id": "Whfndn5YFKSlLRKO",
          "name": "Header Auth account 2"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "‚ùì Is Voice?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Is Voice?": {
      "main": [
        [
          {
            "node": "üîä Get Voice File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üîÄ Merge Voice",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîä Get Voice File": {
      "main": [
        [
          {
            "node": "üì• Download Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Download Audio": {
      "main": [
        [
          {
            "node": "üîÑ Fix Audio Format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Fix Audio Format": {
      "main": [
        [
          {
            "node": "üé§ Groq Whisper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üé§ Groq Whisper": {
      "main": [
        [
          {
            "node": "üìù Set Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Set Transcription": {
      "main": [
        [
          {
            "node": "üîÄ Merge Voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Merge Voice": {
      "main": [
        [
          {
            "node": "üîç Find User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Find User": {
      "main": [
        [
          {
            "node": "‚ùì User Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì User Exists?": {
      "main": [
        [
          {
            "node": "üîÄ Merge User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ûï Create User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ûï Create User": {
      "main": [
        [
          {
            "node": "üìä Create State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Create State": {
      "main": [
        [
          {
            "node": "üîß Prepare User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Prepare User Data": {
      "main": [
        [
          {
            "node": "üîÄ Merge User",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîÄ Merge User": {
      "main": [
        [
          {
            "node": "üìã Get State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Get State": {
      "main": [
        [
          {
            "node": "üîÄ Route Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÄ Route Logic": {
      "main": [
        [
          {
            "node": "‚ùì Onboarding?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Onboarding?": {
      "main": [
        [
          {
            "node": "üéØ Onboarding Handler",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìú Get History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ Onboarding Handler": {
      "main": [
        [
          {
            "node": "‚ùì Skip Main Chain?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Save Feature (Onb)?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Start Course?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Show Full Task?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Set Awaiting Report?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Save Report?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Skip Main Chain?": {
      "main": [
        [],
        [
          {
            "node": "‚ùì Save Name?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Feature (Onb)?": {
      "main": [
        [
          {
            "node": "üíæ Save Feature (Onb)",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "üíæ Save Feature (Onb)": {
      "main": [
        [
          {
            "node": "‚úÖ Set Onboarded",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Set Onboarded": {
      "main": [
        [
          {
            "node": "‚ùì Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Name?": {
      "main": [
        [
          {
            "node": "üíæ Save Name",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Save Style?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Name": {
      "main": [
        [
          {
            "node": "‚ùì Save Style?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Style?": {
      "main": [
        [
          {
            "node": "üíæ Save Style",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Save Slide (Onb)?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Style": {
      "main": [
        [
          {
            "node": "‚ùì Save Slide (Onb)?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Slide (Onb)?": {
      "main": [
        [
          {
            "node": "‚ú® Enhance Slide Place",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Save Morning?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ú® Enhance Slide Place": {
      "main": [
        [
          {
            "node": "üíæ Save Slide (Onb)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Slide (Onb)": {
      "main": [
        [
          {
            "node": "‚ùì Save Morning?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Morning?": {
      "main": [
        [
          {
            "node": "‚ú® Enhance Slide People",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Save Evening?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ú® Enhance Slide People": {
      "main": [
        [
          {
            "node": "üíæ Save Morning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Morning": {
      "main": [
        [
          {
            "node": "‚ùì Save Evening?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Evening?": {
      "main": [
        [
          {
            "node": "‚ú® Enhance Slide Feeling",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Update Step?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ú® Enhance Slide Feeling": {
      "main": [
        [
          {
            "node": "üíæ Save Evening",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Evening": {
      "main": [
        [
          {
            "node": "‚ùì Needs Slide Preview?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Needs Slide Preview?": {
      "main": [
        [
          {
            "node": "üìã Load Full State",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Update Step?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Load Full State": {
      "main": [
        [
          {
            "node": "‚ú® Enhance Full Slide",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ú® Enhance Full Slide": {
      "main": [
        [
          {
            "node": "üì§ Send Slide Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Update Step?": {
      "main": [
        [
          {
            "node": "üìä Update Step",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Update Step": {
      "main": [
        [
          {
            "node": "‚ùì Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìú Get History": {
      "main": [
        [
          {
            "node": "üìã Get Course Task1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Get Course Task1": {
      "main": [
        [
          {
            "node": "üîß Build LLM Context2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Build LLM Context2": {
      "main": [
        [
          {
            "node": "ü§ñ DeepSeek API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ DeepSeek API": {
      "main": [
        [
          {
            "node": "üéØ Parse Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ Parse Actions": {
      "main": [
        [
          {
            "node": "‚ùì Has Slide?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Has Slide?": {
      "main": [
        [
          {
            "node": "üíæ Save Slide (DS)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Has Feature Request?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Change Name?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Change Style?",
            "type": "main",
            "index": 0
          },
          {
            "node": "üíæ Save User Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "üíæ Save Bot Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì§ Send Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Slide (DS)": {
      "main": [
        [
          {
            "node": "‚ùì Has Feature Request?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Change Name?",
            "type": "main",
            "index": 0
          },
          {
            "node": "‚ùì Change Style?",
            "type": "main",
            "index": 0
          },
          {
            "node": "üíæ Save User Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "üíæ Save Bot Msg",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì§ Send Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Has Feature Request?": {
      "main": [
        [
          {
            "node": "üíæ Save Feature Request",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "‚ùì Change Name?": {
      "main": [
        [
          {
            "node": "üíæ Save New Name",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "‚ùì Change Style?": {
      "main": [
        [
          {
            "node": "üíæ Save New Style",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "‚ùì Start Course?": {
      "main": [
        [
          {
            "node": "üöÄ Start Course RPC",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "‚ùì Show Full Task?": {
      "main": [
        [
          {
            "node": "üìã Get Task For Button",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "üìã Get Task For Button": {
      "main": [
        [
          {
            "node": "üì§ Send Full Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Set Awaiting Report?": {
      "main": [
        [
          {
            "node": "üíæ Set Awaiting Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùì Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Set Awaiting Report": {
      "main": [
        [
          {
            "node": "‚ùì Has Text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Save Report?": {
      "main": [
        [
          {
            "node": "üîÑ Save Report RPC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Save Report RPC": {
      "main": [
        [
          {
            "node": "üîß Build Report Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Has Text?": {
      "main": [
        [
          {
            "node": "üì§ Send Onboarding Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Build Report Context": {
      "main": [
        [
          {
            "node": "ü§ñ DeepSeek Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ DeepSeek Report": {
      "main": [
        [
          {
            "node": "üì§ Send Report Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}