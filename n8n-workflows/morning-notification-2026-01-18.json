{
  "name": "Morning Notification (Transurfing)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "â° Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ² ĞœĞ¾ÑĞºĞ²Ğµ (UTC+3)\nconst now = new Date();\nconst moscowOffset = 3 * 60;\nconst utcMinutes = now.getUTCHours() * 60 + now.getUTCMinutes();\nconst moscowMinutes = utcMinutes + moscowOffset;\n\nlet hours = Math.floor(moscowMinutes / 60) % 24;\nlet minutes = moscowMinutes % 60;\n\n// Ğ£Ñ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ 6:00 Ğ´Ğ¾ 10:59\nif (hours < 6 || hours > 10) {\n  return [];\n}\n\n// ĞĞºÑ€ÑƒĞ³Ğ»ÑĞµĞ¼ Ğ´Ğ¾ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚\nconst roundedMinutes = Math.floor(minutes / 15) * 15;\nconst timeToMatch = `${hours.toString().padStart(2, '0')}:${roundedMinutes.toString().padStart(2, '0')}`;\n\n// ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ (+15 Ğ¼Ğ¸Ğ½)\nconst altMinutes = (roundedMinutes + 15) % 60;\nconst altHours = roundedMinutes + 15 >= 60 ? hours + 1 : hours;\nconst timeToMatchAlt = `${altHours.toString().padStart(2, '0')}:${altMinutes.toString().padStart(2, '0')}`;\n\nreturn [{\n  json: {\n    moscowTime: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`,\n    timeToMatch,\n    timeToMatchAlt,\n    hours,\n    minutes\n  }\n}];"
      },
      "id": "check-time",
      "name": "ğŸ• Check Time",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [224, 0]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "valid-time",
              "leftValue": "={{ $json.timeToMatch }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-valid",
      "name": "â“ Valid Time?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [448, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/get_morning_notification_users",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Authorization",
              "value": "Bearer SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_time_to_match",
              "value": "={{ $json.timeToMatch }}"
            },
            {
              "name": "p_time_to_match_alt",
              "value": "={{ $json.timeToMatchAlt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-users",
      "name": "ğŸ“‹ Get Users (RPC)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [672, -96]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.all();\nconst results = [];\n\nconst users = response[0]?.json || [];\nconst userList = Array.isArray(users) ? users : [users];\n\nfor (const data of userList) {\n  if (!data.telegram_id) continue;\n  \n  const name = data.preferred_name || data.first_name || 'Ğ´Ñ€ÑƒĞ³';\n  const slide = data.target_slide || 'Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½';\n  \n  const courseDay = data.course_day;\n  const totalDays = data.course_total_days || 78;\n  const taskTitle = data.task_title;\n  const taskDescription = data.task_description;\n  const taskInterpretation = data.task_interpretation;\n  \n  let message = '';\n  \n  if (courseDay && taskDescription) {\n    message = `ğŸŒ… Ğ”Ğ¾Ğ±Ñ€Ğ¾Ğµ ÑƒÑ‚Ñ€Ğ¾, ${name}!\\n\\nğŸ“… Ğ”ĞµĞ½ÑŒ ${courseDay} Ğ¸Ğ· ${totalDays}${taskTitle ? ': ' + taskTitle : ''}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ“œ Ğ”ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ½Ñ:\\n${taskDescription}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ’¡ Ğ¢Ğ¾Ğ»ĞºĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:\\n${taskInterpretation || 'ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºÑƒĞ¹ Ğ¾ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.'}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nğŸ¯ Ğ¢Ğ²Ğ¾Ğ¹ ÑĞ»Ğ°Ğ¹Ğ´: \"${slide}\"\\n\\nĞ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞ³Ğ¾ Ğ´Ğ½Ñ! âœ¨`;\n  } else {\n    message = `ğŸŒ… Ğ”Ğ¾Ğ±Ñ€Ğ¾Ğµ ÑƒÑ‚Ñ€Ğ¾, ${name}!\\n\\nĞ¢Ğ²Ğ¾Ğ¹ ÑĞ»Ğ°Ğ¹Ğ´:\\n\"${slide}\"\\n\\nĞ—Ğ°ĞºÑ€Ğ¾Ğ¹ Ğ³Ğ»Ğ°Ğ·Ğ° Ğ½Ğ° 30 ÑĞµĞº. ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ ÑÑ‚Ñƒ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ñƒ.\\nĞŸĞ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒĞ¹ â€” ÑÑ‚Ğ¾ ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ âœ¨`;\n  }\n  \n  results.push({\n    json: {\n      user_id: data.user_id,\n      telegram_id: data.telegram_id,\n      message,\n      type: 'morning'\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "prepare-messages",
      "name": "ğŸ“ Prepare Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, -96]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "has-user",
              "leftValue": "={{ $json.telegram_id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-has-users",
      "name": "â“ Has Users?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1104, -96]
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "send-notification",
      "name": "ğŸ“¤ Send Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1328, -208],
      "credentials": {
        "telegramApi": {
          "id": "XlAeiZ4z9NX2UU0N",
          "name": "transerfing"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/rpc/log_notification",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Authorization",
              "value": "Bearer SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_user_id",
              "value": "={{ $('ğŸ“ Prepare Messages').item.json.user_id }}"
            },
            {
              "name": "p_type",
              "value": "morning"
            }
          ]
        },
        "options": {}
      },
      "id": "log-notification",
      "name": "ğŸ“Š Log Notification (RPC)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1552, -208]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hwpxdefkixhrmspqkqsd.supabase.co/rest/v1/user_states?user_id=eq.{{ $('ğŸ“ Prepare Messages').item.json.user_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Authorization",
              "value": "Bearer SUPABASE_ANON_KEY_PLACEHOLDER"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\"awaiting_report\": false}",
        "options": {}
      },
      "id": "reset-awaiting",
      "name": "ğŸ”„ Reset Awaiting Report",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1776, -208]
    },
    {
      "parameters": {},
      "id": "no-op",
      "name": "ğŸš« No Action",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [672, 112]
    },
    {
      "parameters": {},
      "id": "no-users",
      "name": "ğŸš« No Users",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1328, 0]
    },
    {
      "parameters": {
        "content": "## ğŸŒ… Morning Notification\n\nĞ—Ğ°Ğ¿ÑƒÑĞº: ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½\nĞ’Ñ€ĞµĞ¼Ñ: 6:00-10:59 MSK\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚:\n- Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºÑƒÑ€ÑĞ° (Ğ´ĞµĞ½ÑŒ X Ğ¸Ğ· 78)\n- Ğ¡Ğ»Ğ°Ğ¹Ğ´ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸\n\n**RPC Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**\n- get_morning_notification_users\n- log_notification\n\n**Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚:**\n- awaiting_report = false",
        "height": 240,
        "width": 280,
        "color": 5
      },
      "id": "sticky-note",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-240, -60]
    }
  ],
  "connections": {
    "â° Schedule Trigger": {
      "main": [[{"node": "ğŸ• Check Time", "type": "main", "index": 0}]]
    },
    "ğŸ• Check Time": {
      "main": [[{"node": "â“ Valid Time?", "type": "main", "index": 0}]]
    },
    "â“ Valid Time?": {
      "main": [
        [{"node": "ğŸ“‹ Get Users (RPC)", "type": "main", "index": 0}],
        [{"node": "ğŸš« No Action", "type": "main", "index": 0}]
      ]
    },
    "ğŸ“‹ Get Users (RPC)": {
      "main": [[{"node": "ğŸ“ Prepare Messages", "type": "main", "index": 0}]]
    },
    "ğŸ“ Prepare Messages": {
      "main": [[{"node": "â“ Has Users?", "type": "main", "index": 0}]]
    },
    "â“ Has Users?": {
      "main": [
        [{"node": "ğŸ“¤ Send Notification", "type": "main", "index": 0}],
        [{"node": "ğŸš« No Users", "type": "main", "index": 0}]
      ]
    },
    "ğŸ“¤ Send Notification": {
      "main": [[{"node": "ğŸ“Š Log Notification (RPC)", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Log Notification (RPC)": {
      "main": [[{"node": "ğŸ”„ Reset Awaiting Report", "type": "main", "index": 0}]]
    }
  }
}
