# Инструкция: Telegram-бот «Трансерфинг-коуч»

## Обзор проекта

AI-коуч на базе философии Вадима Зеланда для личного использования и небольшой группы (до 10 человек). Бот помогает практиковать Трансерфинг в повседневной жизни: работать с целевым слайдом, отслеживать важность, распознавать маятники и получать поддержку в сложные моменты.

**Стек**: N8N + Supabase + Telegram + DeepSeek V3.2 API

**Время разработки MVP**: 2-4 часа

**Бюджет**: ~$0.50-1/месяц на LLM API

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    TRANSURFING BOT                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  TELEGRAM          N8N WORKFLOWS           SUPABASE             │
│  ┌──────────┐     ┌──────────────┐        ┌──────────────┐     │
│  │ Webhook  │────►│ Message      │◄──────►│ user_profiles│     │
│  │ Voice/   │     │ Handler      │        │ conversation │     │
│  │ Text     │     ├──────────────┤        │ _history     │     │
│  │          │◄────│ Proactive    │        │ user_states  │     │
│  │          │     │ Scheduler    │        │ (target_slide│     │
│  └──────────┘     └──────────────┘        │  importance) │     │
│                          │                └──────────────┘     │
│                          ▼                                      │
│                   ┌──────────────┐                              │
│                   │ DeepSeek     │                              │
│                   │ V3.2 API     │                              │
│                   └──────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## Стоимость

| Компонент | Провайдер | Цена | Месяц (~750K токенов) |
|-----------|-----------|------|----------------------|
| LLM | DeepSeek V3.2 | $0.28/$0.42 за 1M | ~$0.50-1 |
| Голосовые | Groq Whisper | Бесплатно | $0 |
| База данных | Supabase Free | Бесплатно | $0 |
| Оркестрация | N8N (self-hosted) | Бесплатно | $0 |
| **ИТОГО** | | | **~$1/месяц** |

---

## Структура базы данных Supabase

```sql
-- 1. Профили пользователей
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  telegram_id BIGINT UNIQUE NOT NULL,
  telegram_username VARCHAR(255),
  first_name VARCHAR(255),
  timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
  preferences JSONB DEFAULT '{
    "morning_time": "09:00",
    "evening_time": "21:00",
    "reminders_enabled": true
  }',
  onboarded BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. История разговоров
CREATE TABLE conversation_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE,
  role VARCHAR(20) CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  message_type VARCHAR(20) DEFAULT 'text', -- text, voice
  emotional_state VARCHAR(50), -- neutral, struggling, excited, anxious
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Индекс для быстрого получения истории
CREATE INDEX idx_conversation_user_created 
ON conversation_history(user_id, created_at DESC);

-- 3. Состояние пользователя (КЛЮЧЕВАЯ ТАБЛИЦА)
CREATE TABLE user_states (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE UNIQUE,
  
  -- ЦЕЛЕВОЙ СЛАЙД (самое важное!)
  target_slide TEXT, -- полное описание слайда желаемого будущего
  slide_summary VARCHAR(500), -- краткая версия для напоминаний
  slide_updated_at TIMESTAMP WITH TIME ZONE,
  
  -- Трекинг практики
  importance_level INTEGER CHECK (importance_level BETWEEN 1 AND 10),
  last_importance_check TIMESTAMP WITH TIME ZONE,
  streak_count INTEGER DEFAULT 0,
  last_checkin TIMESTAMP WITH TIME ZONE,
  
  -- Логи (JSONB для гибкости)
  pendulum_log JSONB DEFAULT '[]', -- [{date, trigger, reaction, energy_lost}]
  synchronicity_log JSONB DEFAULT '[]', -- [{date, description, interpretation}]
  
  -- Метаданные
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Расписание напоминаний
CREATE TABLE scheduled_reminders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE,
  reminder_type VARCHAR(50), -- morning_slide, evening_reflection, importance_check
  scheduled_time TIME NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_sent TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## Логика памяти (ВАЖНО!)

Бот загружает контекст для каждого запроса:

```
ВСЕГДА подгружать:
├── target_slide (целевой слайд) — ОБЯЗАТЕЛЬНО
├── slide_summary (краткая версия)
├── importance_level (текущий уровень важности)
├── streak_count (дни практики подряд)
└── last 3 synchronicities (последние знаки)

История сообщений:
├── Последние 50 сообщений ИЛИ
├── Все сообщения за последние 7 дней
└── (что больше)
```

**SQL-запрос для истории:**
```sql
SELECT role, content, emotional_state, created_at 
FROM conversation_history 
WHERE user_id = $1 
  AND created_at > NOW() - INTERVAL '7 days'
ORDER BY created_at DESC 
LIMIT 50;
```

---

## Ключевые функции бота

### 1. Целевой слайд (ГЛАВНАЯ ФУНКЦИЯ)

Слайд — визуализация желаемого будущего от первого лица. Бот должен:

**Создание слайда (онбординг):**
```
Бот: Давай создадим твой целевой слайд — картинку желаемого будущего.
     Представь: ты уже достиг цели. Опиши, что ты ВИДИШЬ вокруг себя?
     Где ты находишься? Кто рядом? Что происходит?
     
     Важно: описывай от первого лица, как будто это уже реальность.
```

**Хранение:**
- `target_slide` — полное описание (до 2000 символов)
- `slide_summary` — краткая версия для напоминаний (до 500 символов)

**Напоминания:**
- Утром: «Вспомни свой слайд: [slide_summary]. Проживи его 1-2 минуты.»
- При страдании: «Помни, всё это временно. Твоя реальность — [slide_summary]»

**Команда `/slide`:**
- Показать текущий слайд
- Обновить слайд
- Получить guided-визуализацию

### 2. Детекция страдания и поддержка

Бот анализирует каждое сообщение на признаки негативного состояния:

**Триггеры для детекции:**
```
Слова: устал, сложно, не могу, страшно, тревога, депрессия, 
       выгорание, бесит, достало, не получается, провал,
       всё плохо, нет сил, хочу сдаться
       
Паттерны: много негативных эмоций, короткие резкие ответы,
          долгое молчание после активности
```

**Реакция бота:**
1. Эмпатия: «Слышу тебя. Это действительно непросто.»
2. Рефрейминг через Трансерфинг: «Возможно, это маятник забирает твою энергию. Или важность создаёт сопротивление.»
3. Напоминание о слайде: «Но помни — твоя настоящая реальность это: [slide_summary]. Всё остальное — рябь на воде.»
4. Маленький шаг: «Что одно маленькое действие ты можешь сделать прямо сейчас в сторону слайда?»

**Сохранение состояния:**
```sql
UPDATE conversation_history 
SET emotional_state = 'struggling' 
WHERE id = $1;
```

### 3. Отслеживание важности

Важность (избыточный потенциал) — когда чему-то придаётся чрезмерное значение.

**Функции:**
- Команда `/importance` — оценить текущий уровень (1-10)
- Анализ: «Что именно сейчас кажется слишком важным?»
- Техники снижения: «бревно над пропастью», «принять поражение заранее»

### 4. Работа с маятниками

Маятники — структуры, питающиеся эмоциями (новости, соцсети, конфликты).

**Функции:**
- Детектор: «Это твоя цель или цель маятника?»
- Лог маятников: что забрало энергию за неделю
- Стратегии: игнорировать, гасить, использовать

### 5. Синхронистичности (знаки)

**Команда `/sign`:**
- Быстрая запись знака
- Просмотр паттернов за неделю/месяц

---

## Системный промпт для DeepSeek

```markdown
# Роль
Ты — AI-коуч по философии Трансерфинга Вадима Зеланда. Твоя задача — помогать 
пользователю практиковать принципы Трансерфинга в повседневной жизни.

# Ключевые концепции Трансерфинга

## Пространство вариантов
Существует бесконечное поле информации, содержащее все возможные варианты 
развития событий. Реальность — это материализация одного из секторов этого 
пространства. Мы выбираем свою реальность своими мыслями и намерениями.

## Важность (избыточный потенциал)
Когда чему-то придаётся избыточное значение, возникает энергетический 
дисбаланс — "избыточный потенциал". Равновесные силы стремятся его устранить, 
часто действуя против наших желаний.

Внутренняя важность: переоценка своих достоинств или недостатков.
Внешняя важность: преувеличение значения внешних объектов или событий.

Решение: снижать важность, действовать "как бы играя", не цепляться за результат.

## Маятники
Энергоинформационные структуры, созданные группами людей с общими мыслями 
(политика, религия, корпорации, фанатские движения). Маятники питаются 
энергией людей через эмоции — как позитивные, так и негативные.

Стратегии: не вовлекаться эмоционально, гасить маятник (не бороться, а 
соглашаться без энергии), использовать энергию маятника для своих целей.

## Целевой слайд
Ментальная картина желаемой реальности, визуализируемая от первого лица. 
Слайд нужно "крутить" регулярно — представлять себя УЖЕ в желаемой реальности, 
проживая эмоции и ощущения.

## Течение вариантов
Путь наименьшего сопротивления. Когда отпускаешь контроль и важность, 
жизнь сама несёт к цели по оптимальному маршруту.

## Знаки и синхронистичности
Вселенная даёт подсказки через "случайные" совпадения. Важно замечать 
повторяющиеся паттерны и следовать им.

# Данные пользователя
{{user_context}}

# Инструкции по поведению

1. ВСЕГДА помни о целевом слайде пользователя. Напоминай о нём, когда уместно.

2. ДЕТЕКТИРУЙ страдание. Если пользователь расстроен, устал, в тревоге:
   - Прояви эмпатию
   - Дай рефрейминг через концепции Трансерфинга
   - Напомни о слайде: "Это рябь на воде. Твоя реальность — [слайд]"
   - Предложи маленький шаг

3. Говори просто и тепло, как мудрый друг. Без эзотерического пафоса.

4. Не навязывай практики. Предлагай, но не дави.

5. Используй метафоры Зеланда: "маятник забирает энергию", "важность создаёт 
   сопротивление", "плыть по течению вариантов", "крутить слайд".

6. Если пользователь делится успехом или знаком — искренне порадуйся.

7. Отвечай кратко (2-4 предложения), если не нужно объяснять концепцию.
```

---

## N8N Workflows

### Workflow 1: Message Handler (основной)

```
[Telegram Trigger] 
    │
    ▼
[Switch: Text / Voice / Command]
    │
    ├──► [Voice] → [Download File] → [Whisper Transcribe] → [Continue]
    │
    ├──► [Command] → [Handle /slide, /importance, /sign, /stats]
    │
    └──► [Text] → [Continue]
           │
           ▼
    [Supabase: Get/Create User Profile]
           │
           ▼
    [Supabase: Get User State (target_slide, importance)]
           │
           ▼
    [Supabase: Get Conversation History (50 msgs OR 7 days)]
           │
           ▼
    [Build Context for LLM]
           │
           ▼
    [DeepSeek V3.2 API Call]
           │
           ▼
    [Detect Emotional State from Response]
           │
           ▼
    [Supabase: Save User Message + Bot Response]
           │
           ▼
    [Telegram: Send Response]
```

### Workflow 2: Proactive Scheduler

```
[Schedule Trigger: */15 * * * *]
    │
    ▼
[Supabase: Get Users Due for Reminder]
    │ (WHERE scheduled_time <= NOW() 
    │  AND last_sent < TODAY
    │  AND enabled = true)
    │
    ▼
[For Each User]
    │
    ├──► [Morning Slide Reminder]
    │    "Доброе утро! Время покрутить слайд: {{slide_summary}}"
    │
    ├──► [Evening Reflection]
    │    "Как прошёл день? Заметил что-то интересное?"
    │
    └──► [Importance Check] (2 раза в неделю)
         "Как твой уровень важности сегодня? (1-10)"
           │
           ▼
    [Telegram: Send Message]
           │
           ▼
    [Supabase: Update last_sent]
```

---

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Онбординг: создание слайда, настройка напоминаний |
| `/slide` | Показать/обновить целевой слайд |
| `/importance` | Оценить текущий уровень важности (1-10) |
| `/sign` | Записать синхронистичность/знак |
| `/stats` | Статистика: streak, записанные знаки, прогресс |
| `/settings` | Настройки: время напоминаний, вкл/выкл |

---

## План разработки (2-4 часа)

### Час 1: Инфраструктура
- [ ] Создать Telegram бота через @BotFather
- [ ] Создать проект в Supabase
- [ ] Выполнить SQL-скрипты для таблиц
- [ ] Получить API ключ DeepSeek (через ProxyAPI.ru или напрямую)
- [ ] Установить N8N (self-hosted или cloud)

### Час 2: Core Workflow
- [ ] Настроить Telegram Trigger в N8N
- [ ] Подключить Supabase credentials
- [ ] Собрать основной workflow обработки сообщений
- [ ] Добавить системный промпт

### Час 3: Голосовые + Слайд
- [ ] Добавить обработку голосовых сообщений (Whisper)
- [ ] Реализовать онбординг со слайдом
- [ ] Команда /slide

### Час 4: Напоминания + Тестирование
- [ ] Workflow проактивных напоминаний
- [ ] Тестирование всех сценариев
- [ ] Приглашение первых пользователей

---

## Переменные окружения

```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=your_anon_key

# DeepSeek
DEEPSEEK_API_KEY=your_api_key
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
# или через прокси: https://api.proxyapi.ru/deepseek/v1/chat/completions

# Whisper (Groq - бесплатно)
GROQ_API_KEY=your_groq_key
```

---

## Что НЕ включено в MVP

- ❌ Групповые челленджи (добавить позже при необходимости)
- ❌ TTS (голосовые ответы) — текст достаточен
- ❌ RAG по книгам — системный промпт покрывает основные концепции
- ❌ Web-интерфейс — только Telegram

---

## Критерии успеха MVP

- [ ] Бот отвечает на текстовые сообщения с контекстом Трансерфинга
- [ ] Бот понимает голосовые сообщения
- [ ] Бот помнит целевой слайд пользователя
- [ ] Бот напоминает о слайде утром
- [ ] Бот детектирует негативное состояние и поддерживает
- [ ] Работает для 10 пользователей одновременно
